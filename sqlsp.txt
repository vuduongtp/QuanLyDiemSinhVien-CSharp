ALTER PROC [dbo].[Lay_Tenlogin]
  @USERNAME VARCHAR(50)
  
AS
select tendangnhap=SUSER_SNAME(sid) from sys.sysusers where name=@USERNAME


ALTER PROCEDURE [dbo].[SP_BANGDIEM]
@MALOP NVARCHAR (50),@MAMH NVARCHAR (50),@LANTHI int
AS 
  
   select HO,TEN ,DIEM=ISNULL(DIEM,0) from (select MASV,HO,TEN from SINHVIEN where MALOP=@MALOP and NGHIHOC=0) as sv left join (select * from DIEM where MAMH=@MAMH and LAN=@LANTHI) as d on sv.MASV=d.MASV


ALTER PROCEDURE [dbo].[SP_BANGDIEMTONGKET]
@MALOP NVARCHAR (50)
AS 
  select MASV,HOVATEN=HO+' '+TEN,TENMH,DIEM from V_BANGDIEMTONGKET where MALOP=@MALOP


ALTER PROC [dbo].[SP_DSTHIHETMON]
@MALOP NVARCHAR(10)
AS
select MASV,HOVATEN=HO+' '+TEN,SOTO='',DIEM='',CHUKI='' from SINHVIEN where MALOP=@MALOP and NGHIHOC=0


ALTER PROC [dbo].[SP_TAOLOGIN]
  @LGNAME VARCHAR(50),
  @PASS VARCHAR(50),
  @USERNAME VARCHAR(50),
  @ROLE VARCHAR(50)
AS
  DECLARE @RET INT
  EXEC @RET= SP_ADDLOGIN @LGNAME, @PASS,'QLDSV'
  IF (@RET =1)  -- LOGIN NAME BI TRUNG
     RETURN 1
 
  EXEC @RET= SP_GRANTDBACCESS @LGNAME, @USERNAME
  IF (@RET =1)  -- USER  NAME BI TRUNG
  BEGIN
       EXEC SP_DROPLOGIN @LGNAME
       RETURN 2
  END
  EXEC sp_addrolemember @ROLE, @USERNAME
  IF @ROLE= 'PGV' OR @ROLE= 'KHOA' OR @ROLE='PKETOAN'
    EXEC sp_addsrvrolemember @LGNAME, 'SecurityAdmin'
RETURN 0  -- THANH CONG


CREATE VIEW [dbo].[V_BANGDIEMTONGKET]
AS
select  DIEM.MASV,HO,TEN,MALOP,TENMH,DIEM=MAX(DIEM) from DIEM, (select MASV,HO,TEN,MALOP from SINHVIEN where NGHIHOC=0) as sv,(select MAMH,TENMH from MONHOC) as mh
  where DIEM.MASV = sv.MASV and DIEM.MAMH=mh.MAMH group by DIEM.MASV,HO,TEN,MALOP,TENMH
GO

